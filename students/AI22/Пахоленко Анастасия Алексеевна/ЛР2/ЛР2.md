# Отчёт по лабораторной работе №2

## Простейший чат-бот в Telegram на Aiogram + OpenAI

---

##  Цель работы

Получить навыки работы с библиотекой **Aiogram**, API **OpenAI** и интеграции их в Telegram-бота.

---

##  План

1. Настройка окружения
2. Написание основных функций бота
3. Выполнение заданий

# 2. Основные функции бота

##  Структура проекта

```
2lab/
├── .env
├── .gitignore
├── main.py
├── config.py
├── database.py
├── requirements.txt
├── chat_bot.db
├── handlers/
│   ├── __init__.py
│   ├── commands.py
│   ├── messages.py
│   └── images.py
└── utils/
    ├── __init__.py
    ├── loader.py
    └── gpt.py
```
# 3. Выполнение заданий

##  1. Добавлен системный промпт

Добавлен системный промпт с возможностью настройки через команду /prompt.
##  utils/gpt.py

```python
SYSTEM_PROMPT = """
Ты - полезный ассистент в Telegram-боте. 
Отвечай дружелюбно и информативно. 
Если не знаешь ответа, честно скажи об этом.
Используй эмодзи для более живого общения 
Отвечай на русском языке.
"""
```

Команда для настройки:

/prompt [текст] - установить свой системный промпт

/myprompt - посмотреть текущий промпт

## 2. Бот знает имя пользователя

Бот получает имя пользователя из Telegram и использует его в ответах. Имя сохраняется в базе данных при первом обращении.

 ![1](1.png)

---

## Реализация

### Код из handlers/messages.py:
```python
user_name = message.from_user.first_name or message.from_user.username or "пользователь"
```
### Код из utils/gpt.py:
```python
if user_name and f"Пользователь: {user_name}" not in msg["content"]:
    context_messages[i]["content"] = f"{cleaned_prompt}\nПользователь: {user_name}"
```

## 3. Хранение сообщений в базе данных

## Реализация 
Создана база данных SQLite chat_bot.db с тремя таблицами для хранения:

-Данных пользователей
-Истории всех сообщений
-Контекста текущих диалогов

### Класс Database в database.py:
```python
class Database:
    def __init__(self, db_name: str = "chat_bot.db"):
        self.conn = sqlite3.connect(db_name, check_same_thread=False)
        self.create_tables()
    
    def create_tables(self):
        pass
    
    def add_user(self, user_id: int, username: str = None, first_name: str = None):
        pass
    
    def save_message(self, user_id: int, role: str, content: str):
        pass
    
    def save_context(self, user_id: int, messages: List[Dict]):
        pass
```

## 4. Поддержка контекста диалога

## Реализация

Контекст диалога сохраняется в таблице context в формате JSON. При каждом новом сообщении бот получает историю предыдущих сообщений (до 10 последних).

 ![2](2.png)

Код из utils/gpt.py:

```python
async def get_response_with_context(message: str, user_id: int, user_name: str = None) -> str:
   
    context_messages = db.get_context(user_id)
    
   
    if not context_messages:
        context_messages = [
            {"role": "system", "content": SYSTEM_PROMPT}
        ]
    
    
    context_messages.append({"role": "user", "content": message})
    
   
    response = await client.chat.completions.create(
        model="gpt-4o-mini",
        messages=context_messages[-8:],  
        temperature=0.7,
        max_tokens=1000
    )
```


##  5. Команда `/reset-context`

### Добавлена команда /reset для сброса контекста диалога.

 ![3](3.png)

Код из handlers/commands.py:


```python
@dp.message(Command("reset"))
async def command_reset_handler(message: Message) -> None:
    try:
        user_id = message.from_user.id
        db.clear_context(user_id)
        await message.answer(
            "Контекст диалога успешно сброшен!\n"
            "Я забыл всю нашу предыдущую беседу. Можешь начать новый диалог!"
        )
    except Exception as e:
        logging.error(f"Error occurred: {e}")
        await message.answer("Произошла ошибка при сбросе контекста")
```


## 6. Поддержка отправки изображений

Добавлен обработчик для изображений и других типов медиафайлов.

 ![4](4.png)

Код из handlers/images.py:

```python
@dp.message(F.content_type == "photo")
async def photo_handler(message: Message) -> None:
    try:
        await message.answer(
            "Вы отправили картинку!\n\n"
            "К сожалению, я пока не умею анализировать изображения, "
            "но я хорошо понимаю текст! Напишите мне что-нибудь, и я с радостью помогу!"
        )
    except Exception as e:
        logging.error(f"Error occurred: {e}")
        await message.answer("Произошла ошибка при обработке изображения")
```
Также добавлены обработчики для:

-Документов (F.content_type == "document")
-Видео (F.content_type == "video")
-Аудио (F.content_type == "audio")

---

## Дополнительные команды

Доступные команды бота:

/start - Начало работы с ботом

/reset - Сбросить историю диалога

/prompt [текст] - Установить системный промпт

/myprompt - Посмотреть текущий промпт

/help - Показать справку

# Вывод

#### В ходе лабораторной работы был успешно разработан и реализован интеллектуальный Telegram-бот с интеграцией OpenAI API. Бот обладает следующими ключевыми функциями:

1. Интеграция с OpenAI GPT - использует модель gpt-4o-mini для генерации ответов
2. Поддержка контекста - сохраняет историю диалога до 10 сообщений
3. Хранение данных - использует SQLite базу данных для хранения пользователей и истории сообщений
4. Гибкая настройка - позволяет пользователям устанавливать свои системные промпты
5. Обработка медиа - корректно реагирует на отправку изображений и других файлов
6. Обработка медиа - корректно реагирует на отправку изображений и других файлов
Бот демонстрирует практическое применение современных технологий AI в мессенджерах и может быть использован как основа для более сложных систем, таких как персональные ассистенты, системы поддержки клиентов или образовательные платформы.

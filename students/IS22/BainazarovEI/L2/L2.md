# Лабораторная работа №2. Простейший чат-бот в Telegram

## Цель лабораторной работы

Получение навыков работы с библиотекой Aiogram, связка API OpenAI и написанного бота.

---

## Подготовка к выполнению задания

Перед началом разработки бота был получен токен бота. Для этого в BotFather и выполнить следующие действия: `Start >> Open >> Create new bot` (рис. 1). Далее было создано имя бота и его адрес, при этом адрес обязательно должен кончаться на bot

<img width="464" height="820" alt="image" src="https://github.com/user-attachments/assets/d4f5a198-c74f-4892-9eaf-268b79b01ca4" />

Рисунок 1 – Создание нового бота в BotFather

Далее был получен токен бота (рис. 2). Была создана команда `/start`. Для этого в меню бота во вкладке Commands были заполнены обязательные поля (рис. 3).

<img width="481" height="858" alt="image" src="https://github.com/user-attachments/assets/47c0ff0c-4cf9-44ff-ba31-9b7a6ef60f72" />

Рисунок 2 – Получение токена бота в BotFather

<img width="446" height="793" alt="image" src="https://github.com/user-attachments/assets/52f91164-fa70-440a-ba65-0c8848e11dc9" />

Рисунок 3 – Создание команды в BotFather

После создания бота и получения токена был создан файл `.env` куда были добавлены API-ключ с предыдущей лабораторной работы и токен бота. Файл был добавлен в `.gitignore`. По аналогии с предыдущей лабораторной работой было создано виртуальное окружение (рис. 4) и были установлены соответствующие библиотеки.

<img width="974" height="28" alt="image" src="https://github.com/user-attachments/assets/c84f8220-4cf7-45f3-a0a6-d7a29444177a" />

<img width="974" height="141" alt="image" src="https://github.com/user-attachments/assets/5e489487-0da2-47e0-8f4b-d75d90f52868" />

Рисунок 4 – Создание виртуального окружения

Был создан файл `config.py`, в который будут добавляться переменные окружения (рис.5).

<img width="974" height="342" alt="image" src="https://github.com/user-attachments/assets/9e8de4c3-2023-4066-b4cc-5943edf09d72" />

Рисунок 5 – Файл `config.py`

Далее были созданы папки `handlers` и `utils`. В первой будут храниться обработчики событий, во второй - вспомогательные функции. В обоих были созданы файлы `__init__.py`, которые необходимы для работы папок как пакетов. В папке `utils` были созданы файлы `loader.py` (рис. 6) и `gpt.py` (рис. 7). В файле `loader.py` были импортированы библиотеки, загружены переменные окружения и созданы бот и диспетчер. Также был установлен HTML-парсинг, чтобы можно было использовать HTML-теги в сообщениях. В файл `gpt.py` была перенесена функция `get_response` из предыдущей лабораторной работы

<img width="906" height="346" alt="image" src="https://github.com/user-attachments/assets/416e6ef6-8b2c-452c-bb8a-f8e1c0e29f4a" />

Рисунок 6 – Файл `loader.py`

<img width="699" height="725" alt="image" src="https://github.com/user-attachments/assets/9f45b9e8-9bbc-403b-a6a9-74d48a99415d" />

Рисунок 7 – Файл `gpt.py`

Также в папке `__init__.py` был добавлен код, который позволяет импортировать модули из папки `utils` в другие модули (рис. 8).

<img width="878" height="249" alt="image" src="https://github.com/user-attachments/assets/b8d35cdf-9fc4-4f24-af5b-c4c6e3cc00df" />

Рисунок 8 – Файл `__init__.py` в папке `utils`

В папке `handlers` были созданы файлы `commands.py` (рис. 9) и `messages.py` (рис. 10). В первом будут храниться обработчики команд, во втором - обработчики сообщений. Код `commands.py` выполняет функцию базовой команды `/start`. В случае успешного выполнения, бот отправляет пользователю сообщение с приветствием. В случае ошибки, бот отправляет в логгер сообщение об ошибке. Код `messages.py` выполняет функцию обработки сообщений. В случае успешного выполнения, бот отправляет пользователю ответ от ассистента. В случае ошибки, бот отправляет пользователю сообщение об ошибке. 

<img width="973" height="452" alt="image" src="https://github.com/user-attachments/assets/56d05db3-f199-43d0-90d2-bac422112a07" />

Рисунок 9 – Файл `commands.py`

<img width="974" height="453" alt="image" src="https://github.com/user-attachments/assets/08ffdd73-508a-4329-9136-fbac63e74f37" />

Рисунок 10 – Файл `messages.py`

Также в папке `__init__.py` был добавлен код, который позволяет импортировать модули из папки `handlers` в другие модули (рис. 11).

<img width="973" height="268" alt="image" src="https://github.com/user-attachments/assets/0ce05196-179a-4332-9d76-2c2c33e110d8" />

Рисунок 11 – Файл `__init__.py` в папке handlers

Далее был создан файл `main.py` (рис. 12) в котором диспетчер запускает процесс поллинга - цикл, который слушает входящие сообщения и обрабатывает их. Конструкция `if name == "main"` позволяет запустить код только в случае, если файл запускается напрямую, а не импортируется в другой файл. Внутри устанавливается уровень логирования и запускается процесс поллинга посредством библиотеки `asyncio`. После чего бот был запущен с помощью команды `python main.py`. Видно, что бот функционирует успешно (рис. 13).

<img width="974" height="553" alt="image" src="https://github.com/user-attachments/assets/ba6e936f-e191-4539-bbb3-599838514148" />

Рисунок 12 – Файл `main.py`

<img width="819" height="1066" alt="image" src="https://github.com/user-attachments/assets/50d321e3-b6a0-458f-a6a8-ee8738498a0b" />

Рисунок 13 – Проверка работы бота

---

## Выполнение задания

Для выполнения заданий необходимо было добавить системный промпт к боту. По сути, данное задание уже было готово, так как в коде, который был перенесён из предыдущей лабораторной работы, уже присутствовал системный промпт. Далее необходимо было сделать так, чтобы бот знал имя пользователя и при ответе обращался к нему по имени. Для этого системный промпт был изменён на этот текст:
```bash
"You are a helpful assistant. Always address the user by name before replying. The person you answer to is {user}"
```
, где user – это имя пользователя (`message.from_user.full_name`) (рис. 14). Чтобы исправить ошибки, связанные с тем, что нейросеть возвращает текст с форматированием, которые Telegram не может распарсить, было отключено форматирование при отправке с помощью данной команды в коде (рис. 15): `parse_mode=None`

<img width="725" height="782" alt="image" src="https://github.com/user-attachments/assets/c0d351d5-a007-459b-9090-9b28a5d48b9f" />

Рисунок 14 – Добавление и изменение системного промпта, чтобы бот обращался по имени

<img width="973" height="351" alt="image" src="https://github.com/user-attachments/assets/62bc5ab4-5477-45c6-a57c-cd85e04c3eb0" />

Рисунок 15 – Исправление ошибок, связанных с форматированием

Также необходимо было добавить хранение сообщений в базе данных, добавить поддержку контекста диалога с помощью базы данных и добавить команду, которая будет сбрасывать контекст диалога. Для этого был создан файл `database.py`, куда была перенесена таблица базы данных сообщений из предыдущей лабораторной работы. Код в `gpt.py` был отредактирован так, чтобы сообщения сохранялись в базу данных (рис. 16). Для сброса контекста диалога была добавлена новая команда и новый обработчик команды в `commands.py` (`Command("resetcontext")`) (рис. 17) Видно, что сообщения действительно сохраняются в базу данных, а контекст диалога сохраняется (рис. 18).

<img width="973" height="351" alt="image" src="https://github.com/user-attachments/assets/1fe31351-6ce7-40b4-9341-6f3d88994bbc" />

Рисунок 16 – Отредактированный файл `gpt.py` для сохранения сообщений в базу данных

<img width="973" height="330" alt="image" src="https://github.com/user-attachments/assets/d947de40-1d64-4861-9532-78f8c21262eb" />

Рисунок 17 – Добавление команды для сброса контекста диалога

<img width="846" height="604" alt="image" src="https://github.com/user-attachments/assets/0d6d2f10-0afa-4b7d-8dfd-840052b13b89" />

<img width="848" height="566" alt="image" src="https://github.com/user-attachments/assets/12ad0d5b-9cd7-4941-a1e3-b139f3ec61d0" />

Рисунок 18 – Проверка контекта диалога

Последним заданием было добавление поддержки отправки изображений, чтобы после отправления изображения бот текстом отвечал "Вы отправили картинку!". Для этого в `messages.py` был обработчик изображений `(F.photo)` (рис. 19). Видно, что бот выполняет функцию как требуется (рис. 20).

<img width="774" height="323" alt="image" src="https://github.com/user-attachments/assets/44047be6-e6a3-4224-bad7-51b3a58f9e41" />

Рисунок 19 – Обработчик изображений

<img width="775" height="325" alt="image" src="https://github.com/user-attachments/assets/3d146b5e-3d17-4afe-829d-c2348eb3c9f9" />

Рисунок 20 – Проверка обработчика изображений
